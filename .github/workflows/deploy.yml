name: Deploy to ECS

on:
  push:
    branches: ['main']
  pull_request:
    branches: ['main']

env:
  AWS_REGION: eu-west-1
  ECR_REGISTRY: 449591255785.dkr.ecr.eu-west-1.amazonaws.com
  ECS_CLUSTER: conference-booking-cluster

permissions:
  id-token: write
  contents: read

jobs:
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.filter.outputs.services }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Detect changed services
        id: filter
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_SHA=${{ github.event.pull_request.base.sha }}
          else
            BASE_SHA=${{ github.event.before }}
          fi
          
          SERVICES=""
          for service in weather-service location-service booking-service room-service auth-service; do
            if git diff --name-only $BASE_SHA HEAD | grep -q "^services/$service/"; then
              SERVICES="$SERVICES\"$service\","
            fi
          done
          
          # Remove trailing comma and wrap in array
          SERVICES="[${SERVICES%,}]"
          echo "services=$SERVICES" >> $GITHUB_OUTPUT
          
          # Check frontend
          if git diff --name-only $BASE_SHA HEAD | grep -q "^frontend/"; then
            echo "frontend=true" >> $GITHUB_OUTPUT
          else
            echo "frontend=false" >> $GITHUB_OUTPUT
          fi

  test-services:
    name: Test Services
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.services != '[]'
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.services) }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
      - run: cd ./services/${{ matrix.service }} && npm install
      - run: cd ./services/${{ matrix.service }} && npm test
        env:
          JWT_SECRET: ${{ secrets.JWT_SECRET }}

  deploy-services:
    name: Deploy Services
    runs-on: ubuntu-latest
    needs: [detect-changes, test-services]
    if: github.event_name == 'push' && needs.detect-changes.outputs.services != '[]'
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.services) }}
    steps:
      - uses: actions/checkout@v3
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-1
      - name: Login to Amazon ECR
        run: aws ecr get-login-password --region eu-west-1 | docker login --username AWS --password-stdin 449591255785.dkr.ecr.eu-west-1.amazonaws.com
      - name: Build and push
        run: |
          cd services/${{ matrix.service }}
          docker build --platform linux/amd64 -t ${{ matrix.service }} .
          docker tag ${{ matrix.service }}:latest 449591255785.dkr.ecr.eu-west-1.amazonaws.com/${{ matrix.service }}:latest
          docker push 449591255785.dkr.ecr.eu-west-1.amazonaws.com/${{ matrix.service }}:latest
      - name: Force ECS deployment
        run: |
          aws ecs update-service \
            --cluster conference-booking-cluster \
            --service ${{ matrix.service }} \
            --force-new-deployment \
            --region eu-west-1
  
  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-services]
    if: always() && github.event_name == 'push' && needs.detect-changes.outputs.frontend == 'true' && (needs.deploy-services.result == 'success' || needs.deploy-services.result == 'skipped')
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        run: |
          aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY
        
      - name: Build and push frontend
        run: |
          cd frontend
          docker build --platform linux/amd64 -t frontend .
          docker tag frontend:latest $ECR_REGISTRY/frontend:latest
          docker push $ECR_REGISTRY/frontend:latest

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY_B64 }}" | base64 -d > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2 via SSH
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            set -e
            
            aws ecr get-login-password --region eu-west-1 | docker login --username AWS --password-stdin 449591255785.dkr.ecr.eu-west-1.amazonaws.com
            
            docker pull 449591255785.dkr.ecr.eu-west-1.amazonaws.com/frontend:latest
            
            docker stop frontend || true
            docker rm frontend || true
            
            docker run -d \
              --name frontend \
              -p 80:80 \
              --restart unless-stopped \
              449591255785.dkr.ecr.eu-west-1.amazonaws.com/frontend:latest
            
            docker image prune -af
          ENDSSH